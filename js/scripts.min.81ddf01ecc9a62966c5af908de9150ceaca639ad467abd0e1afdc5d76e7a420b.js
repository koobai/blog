var body=document.querySelector("body"),menuTrigger=document.querySelector("#toggle-menu-main-mobile"),menuContainer=document.querySelector("#menu-main-mobile"),hamburgerIcon=document.querySelector(".hamburger");menuTrigger!==null&&menuTrigger.addEventListener("click",function(){menuContainer.classList.toggle("open"),hamburgerIcon.classList.toggle("is-active"),body.classList.toggle("lock-scroll")}),window.onscroll=function(){document.body.scrollTop>500||document.documentElement.scrollTop>500?document.getElementById("gotop").style.display="block":document.getElementById("gotop").style.display="none"};function smoothScrollTop(){var e=null;cancelAnimationFrame(e),e=requestAnimationFrame(function t(){var n=document.body.scrollTop||document.documentElement.scrollTop;n>0?(document.body.scrollTop=document.documentElement.scrollTop=n-150,e=requestAnimationFrame(t)):cancelAnimationFrame(e)})}window.ViewImage&&ViewImage.init(".content_zhengwen img, .top-img,.gallery-thumbnail img,.posts_photo a,.photo-moment a");function animateSummaries(){const e=document.querySelectorAll(".img-hide, .retu-hide");if(e.length===0)return;const n={rootMargin:"0px 0px 50px 0px"},t=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const n=e.target,s=Math.random()*150;setTimeout(()=>{n.classList.add("visible")},s),t.unobserve(n)}})},n);e.forEach(e=>{t.observe(e)})}animateSummaries(),window.formatDate=(e,t=!1)=>{if(!e)return"";let o=isNaN(e)?new Date(e).getTime():Number(e);o<1e12&&(o*=1e3);const a=Date.now(),n=a-o,s=new Date(o);if(n<6e4)return`${Math.max(1,Math.floor(n/1e3))} 秒前`;if(n<36e5)return`${Math.floor(n/6e4)} 分钟前`;if(n<864e5)return`${Math.floor(n/36e5)} 小时前`;if(n<6048e5)return`${Math.floor(n/864e5)} 天前`;const[i,r,c,l,d]=[s.getFullYear(),s.getMonth()+1,s.getDate(),s.getHours(),s.getMinutes()].map(e=>String(e).padStart(2,"0"));return`${i==(new Date).getFullYear()?"":i+"年"}${r}月${c}日${t?` ${l}:${d}`:""}`},document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".twitter-time").forEach(e=>{e.dataset.time&&(e.innerText=window.formatDate(e.dataset.time,!1))})}),document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("unified-search-input"),e=document.getElementById("unified-search-list");if(!t||!e)return;const r=`https://memos.koobai.com/api/v1/memos?parent=users/1`;let n={blog:[],memos:[]},s=!1,o;const i=e=>(e||"").replace(/!\[.*?\]\(.*?\)/g,"[图片]").replace(/\[(.*?)\]\(.*?\)/g,"$1").replace(/[#*`]/g,"").replace(/<[^>]+>/g,"").trim(),c=e=>typeof window.formatDate=="function"?window.formatDate(e):new Date(e*1e3).toLocaleDateString(),l=async()=>{let t=[],e="";do{const s=`${r}&pageSize=200${e?`&pageToken=${e}`:""}`,n=await fetch(s).then(e=>e.json());if(n.memos){const e=n.memos.filter(e=>e.visibility==="PUBLIC");t=t.concat(e)}e=n.nextPageToken}while(e)return t},d=async()=>{if(s)return;try{const[e,t]=await Promise.allSettled([fetch("/index.json").then(e=>e.json()),l()]);e.status==="fulfilled"&&e.value&&(n.blog=e.value.map(e=>({title:e.title,link:e.permalink,_txt:i(e.title+e.content)}))),t.status==="fulfilled"&&t.value&&(n.memos=t.value.map(e=>{const t=e.createTime?Math.floor(new Date(e.createTime)/1e3):Date.now()/1e3;return{title:`${c(t)}`,link:`/?memo=${e.name.split("/").pop()}`,_txt:i(e.content)}})),s=!0}catch(e){console.error("索引加载失败",e)}},a=(e,t,n,s)=>{if(!e.length)return"";let o="",a=0,i=new RegExp(`(${t.join("|")})`,"gi");for(const s of e){const c=s._txt.toLowerCase();if(!t.every(e=>c.includes(e)))continue;const l=c.indexOf(t[0]),r=Math.max(0,l-10),d=(r>0?"...":"")+s._txt.substring(r,r+50)+"...",u=s.title.replace(i,'<mark class="search-highlight">$1</mark>'),h=d.replace(i,'<mark class="search-highlight">$1</mark>');if(o+=`<li><a href="${s.link}" target="_blank">
                <span class="search-title">${u}</span><span class="search-snippet">${h}</span>
            </a></li>`,++a>=n)break}return o?`<li class="search-section-title">${s}</li>${o}`:""};t.addEventListener("focus",d),t.addEventListener("input",()=>{clearTimeout(o),o=setTimeout(()=>{const o=t.value.trim().toLowerCase(),s=o.split(/\s+/).filter(e=>e).map(e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"));if(!s.length)return e.style.display="none";const i=a(n.blog,s,999,"博文"),r=a(n.memos,s,20,"唠叨");e.innerHTML=i+r||'<li class="search-none">无结果，没写过</li>',e.style.display="block"},300)}),document.addEventListener("keydown",n=>{n.key==="Escape"&&(e.style.display="none",t.blur())}),document.addEventListener("click",n=>{n.target!==t&&!e.contains(n.target)&&(e.style.display="none")})}),document.body.addEventListener("click",function(e){const t=e.target.closest(".atk-comment-wrap a");if(t&&!t.href.includes("koobai.com")){e.preventDefault();try{const e=btoa(encodeURIComponent(t.href)),n="/tiaozhuan?target="+e;window.open(n,"_blank")}catch(e){console.error("链接编码失败:",e),window.open(t.href,"_blank")}}})