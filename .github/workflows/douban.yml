name: Download Douban Posters

on:
  workflow_dispatch:
  push:
    paths:
      - assets/movie.csv

jobs:
  download:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ‹‰å½“å‰ä»“åº“ï¼ˆæœ‰ CSVï¼‰
      - name: Checkout source repo
        uses: actions/checkout@v4

      # 2ï¸âƒ£ è®¾ç½® Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          pip install pandas requests

      # 3ï¸âƒ£ ä¸‹è½½å›¾ç‰‡åˆ°ä¸´æ—¶ç›®å½• (âš ï¸ æ ¸å¿ƒä¿®æ”¹ï¼šå¢åŠ äº†ä»£ç†é˜²å°é”)
      - name: Download posters
        run: |
          python - <<EOF
          import pandas as pd
          import requests
          import os
          import time

          # è¯»å– CSV
          try:
              df = pd.read_csv("assets/movie.csv")
          except Exception as e:
              print(f"Error reading CSV: {e}")
              exit(0) # æ²¡æ–‡ä»¶å°±ä¼˜é›…é€€å‡º
              
          save_dir = "douban"
          os.makedirs(save_dir, exist_ok=True)
          
          # ä¼ªè£… Header
          headers = {
              'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
          }

          print("ğŸš€ Starting smart download...")

          for _, row in df.iterrows():
              poster = row["poster"]
              movie_id = str(row["id"])

              if not isinstance(poster, str) or not poster.startswith('http'):
                  continue

              # æœ¬åœ°å­˜å‚¨è·¯å¾„ï¼šä½¿ç”¨ ID.jpg (å¦‚ 123456.jpg)
              path = os.path.join(save_dir, f"{movie_id}.jpg")
              
              # å¦‚æœå·²ç»ä¸‹è½½è¿‡ï¼Œè·³è¿‡
              if os.path.exists(path):
                  continue

              # --- ä»£ç†é€»è¾‘ ---
              # å»æ‰åè®®å¤´ï¼Œæ„é€  WP CDN é“¾æ¥
              clean_url = poster.replace("https://", "").replace("http://", "")
              # ä¼˜å…ˆä½¿ç”¨ i0.wp.com ä»£ç† (æœ€ç¨³)
              proxy_url = f"https://i0.wp.com/{clean_url}"

              try:
                  print(f"â¬‡ï¸ Downloading {movie_id} via Proxy...")
                  r = requests.get(proxy_url, headers=headers, timeout=20)
                  
                  if r.status_code == 200:
                      # ç®€å•çš„æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥
                      if len(r.content) < 1000:
                          print(f"   âš ï¸ Warning: File too small, skipping.")
                          continue
                          
                      with open(path, "wb") as f:
                          f.write(r.content)
                      print(f"   âœ… Success: {movie_id}.jpg")
                      time.sleep(0.2) # ç¨å¾®ä¼‘æ¯é˜²é£æ§
                  else:
                      print(f"   âŒ Failed ({r.status_code}): {poster}")

              except Exception as e:
                  print(f"   âŒ Error: {e}")
          EOF

      # 4ï¸âƒ£ checkout img ä»“åº“
      - name: Checkout img repo
        uses: actions/checkout@v4
        with:
          repository: koobai/img  # ğŸ‘ˆ å·²å¸®ä½ å¡«å¥½
          token: ${{ secrets.IMG_REPO_TOKEN }}
          path: img-repo

      # 5ï¸âƒ£ æ‹·è´å›¾ç‰‡è¿›å»
      - name: Copy images
        run: |
          mkdir -p img-repo/douban
          # -n: ä¸è¦†ç›–å·²å­˜åœ¨æ–‡ä»¶ï¼Œåªå¢é‡æ·»åŠ 
          cp -n douban/* img-repo/douban/ || true

      # 6ï¸âƒ£ æäº¤å¹¶æ¨é€ï¼ˆæœ‰å˜åŒ–æ‰æäº¤ï¼‰
      - name: Commit & push
        run: |
          cd img-repo
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "chore: sync douban posters via workflow"
            git push
          else
            echo "No changes"
          fi