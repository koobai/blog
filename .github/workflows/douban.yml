name: douban
on: 
  workflow_dispatch:
  # schedule:
  #   - cron: '0 18 * * *'

jobs:
  douban:
    name: Douban mark data sync
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Blog Repo
      uses: actions/checkout@v3

    # 1. å‡†å¤‡å›¾ç‰‡ä»“åº“ (å…‹éš†åˆ° img_repo ç›®å½•)
    - name: Checkout Private Img Repo
      uses: actions/checkout@v3
      with:
        repository: koobai/img
        token: ${{ secrets.MY_IMG_TOKEN }}
        path: img_repo

    # 2. åŒæ­¥è±†ç“£æ•°æ® (ç”Ÿæˆ assets/movie.csv)
    - name: Douban movie sync
      uses: lizheming/doumark-action@master
      with:
        id: jnnsu
        type: movie
        format: csv
        dir: ./assets

    # 3. å‡†å¤‡ Python ç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: pip install pandas requests

    # 4. æ ¸å¿ƒä¸‹è½½è„šæœ¬ (wsrv.nl ä»£ç†ç‰ˆ)
    - name: Download Posters
      run: |
        python - <<EOF
        import pandas as pd
        import requests
        import os
        import time
        from urllib.parse import quote

        def download():
            csv_path = './assets/movie.csv'
            save_folder = './img_repo/douban/'
            os.makedirs(save_folder, exist_ok=True)
            
            if not os.path.exists(csv_path):
                print("âŒ CSVæ–‡ä»¶æœªæ‰¾åˆ°")
                return

            try:
                # è¯»å– CSV
                df = pd.read_csv(csv_path)
            except Exception as e:
                print(f"âŒ è¯»å–CSVå‡ºé”™: {e}")
                return
            
            print(f"ğŸ“Š å¼€å§‹å¤„ç† {len(df)} æ¡æ•°æ®...")
            
            # ä¼ªè£…å¤´ (è™½ç„¶èµ°ä»£ç†ï¼Œå¸¦ä¸Šæ›´ç¨³)
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
            }

            for index, row in df.iterrows():
                image_url = row['poster']
                
                # 1. åŸºç¡€æ£€æŸ¥
                if pd.isna(image_url) or not str(image_url).startswith('http'):
                    continue

                # 2. ä½¿ç”¨ id å‘½åå›¾ç‰‡ (ä¾‹å¦‚ 35774681.jpg)
                movie_id = str(row['id'])
                file_name = f"{movie_id}.jpg"
                save_path = os.path.join(save_folder, file_name)
                
                # 3. å¢é‡æ£€æŸ¥ï¼šå¦‚æœå›¾å·²å­˜åœ¨ï¼Œç›´æ¥è·³è¿‡
                if os.path.exists(save_path):
                    continue
                
                # 4. æ„é€  wsrv ä»£ç†é“¾æ¥ (æ ¸å¿ƒé˜²å°é”é€»è¾‘)
                # åŸç†: GitHub -> wsrv.nl -> lithub.cc -> è¿”å›å›¾ç‰‡
                try:
                    # å»æ‰åè®®å¤´
                    clean_url = image_url.replace('https://', '').replace('http://', '')
                    # URL ç¼–ç ï¼Œé˜²æ­¢ç‰¹æ®Šå­—ç¬¦å¯¼è‡´ wsrv è§£æé”™è¯¯
                    encoded_url = quote(clean_url, safe='')
                    # æ‹¼æ¥ä»£ç†åœ°å€
                    proxy_url = f"https://wsrv.nl/?url={encoded_url}"

                    print(f"ğŸ“¥ ä»£ç†ä¸‹è½½ä¸­: {movie_id}")
                    
                    # å‘èµ·è¯·æ±‚
                    res = requests.get(proxy_url, headers=headers, timeout=60)
                    
                    # 5. æ ¡éªŒå¹¶ä¿å­˜ (æ’é™¤ 404 æˆ– æŠ¥é”™é¡µé¢)
                    # wsrv å¦‚æœå¤±è´¥å¯èƒ½ä¼šè¿”å› JSON æˆ– HTMLï¼Œæˆ‘ä»¬è¦æ’é™¤æ‰
                    if res.status_code == 200 and res.content[:4] != b'{' and res.content[:4] != b'<htm':
                        with open(save_path, 'wb') as f:
                            f.write(res.content)
                        # ç¤¼è²Œå»¶æ—¶
                        time.sleep(0.5)
                    else:
                        print(f"âš ï¸ ä»£ç†å¤±è´¥æˆ–è¿”å›å¼‚å¸¸å†…å®¹: {image_url}")
                        
                except Exception as e:
                    print(f"âŒ ä¸‹è½½å¼‚å¸¸: {e}")

        if __name__ == "__main__":
            download()
        EOF

    # 5. æ¨é€å›¾ç‰‡åˆ° koobai/img ä»“åº“
    - name: Push to Img Repo
      run: |
        cd img_repo
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        mkdir -p douban
        git add douban/
        # ä»…åœ¨æœ‰æ–°å›¾ç‰‡æ—¶æäº¤
        git commit -m "chore: sync posters via wsrv" || exit 0
        git push

    # 6. æäº¤ CSV æ›´æ–°åˆ°å½“å‰ blog ä»“åº“
    - name: Commit Blog CSV
      id: commit_step
      uses: EndBug/add-and-commit@v9
      with:
        message: 'chore: update douban data'
        add: './assets'
        
    # 7. è§¦å‘åšå®¢æ„å»º
    - name: Trigger Blog
      if: steps.commit_step.outputs.committed == 'true'
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'githubblog.yml',
            ref: 'main'
          })