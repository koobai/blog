name: douban
on: 
  workflow_dispatch:
 # schedule:
 #   - cron: '0 18 * * *'

jobs:
  douban:
    name: Douban mark data sync
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: movie
      uses: lizheming/doumark-action@master
      with:
        id: jnnsu
        type: movie
        format: csv
        dir: ./assets

    # --- ç¬¬ä¸€æ­¥ï¼šè®¾ç½®ç¯å¢ƒå¹¶ä¸‹è½½å›¾ç‰‡ ---
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Dependencies
      run: pip install pandas requests

    - name: Download Posters
      run: |
        python - <<EOF
        import pandas as pd
        import requests
        import os
        import time

        # 1. å‡†å¤‡å·¥ä½œ
        csv_path = "./assets/movie.csv"
        if not os.path.exists(csv_path):
            print(f"âŒ Error: {csv_path} not found!")
            exit(1)

        df = pd.read_csv(csv_path)
        save_dir = "temp_posters"
        os.makedirs(save_dir, exist_ok=True)
        
        # 2. ä¼ªè£…å¤´éƒ¨ (æ¨¡æ‹ŸçœŸå®çš„ Chrome æµè§ˆå™¨)
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Referer': 'https://movie.douban.com/', # æœ‰äº›é•œåƒæºéœ€è¦ Refererï¼Œæœ‰äº›ä¸éœ€è¦ï¼ŒåŠ ä¸Šæ›´ç¨³
            'Accept': 'image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8'
        }

        success_count = 0
        fail_count = 0

        for _, row in df.iterrows():
            url = row["poster"]
            if not isinstance(url, str) or not url.startswith('http'):
                continue
            
            # æå–æ–‡ä»¶å (ID.jpg)
            img_name = os.path.basename(url)
            file_path = os.path.join(save_dir, img_name)
            
            # å¦‚æœæœ¬åœ°å·²æœ‰ï¼Œè·³è¿‡
            if os.path.exists(file_path):
                print(f"â© Skipping existing: {img_name}")
                continue

            # 3. ä¸‹è½½å°è¯• (å¸¦é‡è¯•)
            downloaded = False
            for attempt in range(2): # æœ€å¤šè¯• 2 æ¬¡
                try:
                    print(f"â¬‡ï¸ Downloading {img_name} (Attempt {attempt+1})...")
                    r = requests.get(url, headers=headers, timeout=15)
                    
                    if r.status_code == 200:
                        # æ£€æŸ¥æ˜¯ä¸æ˜¯å‡å›¾ç‰‡ (æ¯”å¦‚é˜²ç›—é“¾è¿”å›çš„ html)
                        if r.content[:4] == b"<htm" or len(r.content) < 1000:
                            print(f"   âš ï¸ Warning: Content looks like HTML or too small. Code: {r.status_code}")
                            fail_count += 1
                            break # è¿™ç§ä¸€èˆ¬æ˜¯é˜²ç›—é“¾ï¼Œé‡è¯•ä¹Ÿæ²¡ç”¨ï¼Œè·³è¿‡
                        
                        with open(file_path, "wb") as f:
                            f.write(r.content)
                        print(f"   âœ… Success: {img_name}")
                        success_count += 1
                        downloaded = True
                        time.sleep(0.5) # ç¨å¾®æ…¢ä¸€ç‚¹ï¼Œé˜²æ­¢è¢«å° IP
                        break
                    else:
                        print(f"   âŒ Failed. HTTP Status: {r.status_code}")
                
                except Exception as e:
                    print(f"   âŒ Error: {e}")
                    time.sleep(1) # å‡ºé”™æ­‡ 1 ç§’
            
            if not downloaded:
                fail_count += 1

        print(f"\nğŸ‰ Summary: Success {success_count}, Failed {fail_count}")
        # å¦‚æœå…¨éƒ¨å¤±è´¥ï¼Œå¼ºåˆ¶è®© Action æŠ¥é”™ï¼Œæ–¹ä¾¿ä½ æ”¶åˆ°é‚®ä»¶é€šçŸ¥
        if success_count == 0 and fail_count > 0:
            exit(1)
        EOF

    # --- ç¬¬äºŒæ­¥ï¼šåŒæ­¥åˆ° img ä»“åº“çš„ douban ç›®å½• ---
    - name: Checkout img repo
      uses: actions/checkout@v3
      with:
        repository: koobai/img # ä½ çš„å›¾ç‰‡ä»“åº“
        token: ${{ secrets.IMG_REPO_TOKEN }} # éœ€åœ¨åšå®¢ä»“åº“è®¾ç½®æ­¤ Secret
        path: img-repo

    - name: Sync and Push Images
      run: |
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        mkdir -p img-repo/douban
        # -n ä¸è¦†ç›–å·²å­˜åœ¨çš„å›¾ç‰‡ï¼Œåªå¢é‡æ·»åŠ 
        cp -n temp_posters/* img-repo/douban/ || true
        
        cd img-repo
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # åªæœ‰å½“ img ä»“åº“æœ‰æ–°å›¾æ—¶æ‰æäº¤
        if [ -n "$(git status --porcelain)" ]; then
          git add .
          git commit -m "chore: sync new douban posters"
          git push
        else
          echo "No new images to sync."
        fi

    # --- ç¬¬ä¸‰æ­¥ï¼šæäº¤ CSV å˜åŠ¨å¹¶è§¦å‘åšå®¢æ„å»º ---
    - name: Commit
      id: commit_step
      uses: EndBug/add-and-commit@v9
      with:
        message: 'chore: update douban data'
        add: './assets'
        
    - name: Trigger Blog
      if: steps.commit_step.outputs.committed == 'true'
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'githubblog.yml',
            ref: 'main'
          })