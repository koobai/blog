name: douban
on: 
  workflow_dispatch:
  # schedule:
  #   - cron: '0 18 * * *'

jobs:
  douban:
    name: Douban mark data sync
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Blog Repo
      uses: actions/checkout@v3

    # 1. 准备图片仓库
    - name: Checkout Private Img Repo
      uses: actions/checkout@v3
      with:
        repository: koobai/img
        token: ${{ secrets.MY_IMG_TOKEN }}
        path: img_repo

    # 2. 同步豆瓣数据
    - name: Douban movie sync
      uses: lizheming/doumark-action@master
      with:
        id: jnnsu
        type: movie
        format: csv
        dir: ./assets

    # 3. 准备 Python 环境
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: pip install pandas requests

    # 4. 核心下载脚本（严格复刻 douban.py 逻辑）
    - name: Download Posters
      run: |
        python - <<EOF
        import pandas as pd
        import requests
        import os

        def download():
            # 路径适配你的 Action 环境
            csv_path = './assets/movie.csv'
            save_dir = './img_repo/douban/'
            os.makedirs(save_dir, exist_ok=True)
            
            # 读取 CSV
            if not os.path.exists(csv_path):
                print("CSV file not found")
                return
            
            try:
                df = pd.read_csv(csv_path)
            except Exception as e:
                print(f"Error reading CSV: {e}")
                return

            print(f"Starting download for {len(df)} items...")

            for index, row in df.iterrows():
                image_url = row.get('poster')
                
                # 基础检查
                if not isinstance(image_url, str) or not image_url.startswith('http'):
                    continue
                
                # --- 逻辑复刻 douban.py ---
                # 1. 文件名规则：直接取 URL 最后一段
                image_name = image_url.split("/")[-1]
                save_path = os.path.join(save_dir, image_name)
                
                # 2. 增量检查
                if os.path.exists(save_path):
                    continue
                
                # 3. Headers 逻辑 (完全照搬 douban.py)
                if 'koobai.com' in image_url:
                    headers = {'Referer': 'https://koobai.com'}
                else:
                    headers = {'Referer': 'https://doubanio.com'}
                
                try:
                    print(f"Downloading: {image_name}")
                    # 4. 请求逻辑 (完全照搬 douban.py)
                    response = requests.get(image_url, headers=headers, timeout=30)
                    
                    if response.status_code == 200:
                        with open(save_path, 'wb') as f:
                            f.write(response.content)
                    else:
                        print(f"Failed status: {response.status_code}")
                        
                except Exception as e:
                    print(f"Error downloading {image_name}: {e}")

        if __name__ == '__main__':
            download()
        EOF

    # 5. 推送图片到 img 仓库
    - name: Push to Img Repo
      run: |
        cd img_repo
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        # 确保目录存在
        mkdir -p douban
        git add douban/
        # 有变动才提交
        if [[ -n $(git status -s) ]]; then
          git commit -m "chore: sync posters via douban.py logic"
          git push
        else
          echo "No new images to push."
        fi

    # 6. 提交 CSV 更新到当前 blog 仓库
    - name: Commit Blog CSV
      id: commit_step
      uses: EndBug/add-and-commit@v9
      with:
        message: 'chore: update douban data'
        add: './assets'
        
    # 7. 触发博客构建
    - name: Trigger Blog
      if: steps.commit_step.outputs.committed == 'true'
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'githubblog.yml',
            ref: 'main'
          })