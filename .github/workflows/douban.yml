name: douban
on: 
  workflow_dispatch:

jobs:
  douban:
    name: Douban mark data sync
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Blog Repo
      uses: actions/checkout@v3

    # 1. å‡†å¤‡å›¾ç‰‡ç¯®å­ (koobai/img)
    - name: Checkout Private Img Repo
      uses: actions/checkout@v3
      with:
        repository: koobai/img
        token: ${{ secrets.MY_IMG_TOKEN }}
        path: img_repo

    # 2. åŒæ­¥æ•°æ® (ç”Ÿæˆ assets/movie.csv)
    - name: Douban movie sync
      uses: lizheming/doumark-action@master
      with:
        id: jnnsu
        type: movie
        format: csv
        dir: ./assets
        # ä¸ç”¨é…ç½® domainï¼Œé»˜è®¤å°±è¡Œ

    # 3. å‡†å¤‡ Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: pip install pandas requests

    # 4. ä¸‹è½½è„šæœ¬ (å¤åˆ»ä½ çš„ douban.py é€»è¾‘ + ç©¿é€å°é”)
    - name: Download Posters
      run: |
        python - <<EOF
        import pandas as pd
        import requests
        import os
        import time

        def download():
            # è·¯å¾„è®¾ç½®
            csv_path = './assets/movie.csv'
            save_dir = './img_repo/douban/'
            os.makedirs(save_dir, exist_ok=True)
            
            if not os.path.exists(csv_path):
                print("âŒ CSV æœªæ‰¾åˆ°")
                return
            
            try:
                df = pd.read_csv(csv_path)
            except Exception as e:
                print(f"âŒ è¯»å– CSV å¤±è´¥: {e}")
                return

            print(f"ğŸ“Š å¼€å§‹å¤„ç† {len(df)} æ¡æ•°æ®...")

            for index, row in df.iterrows():
                image_url = row.get('poster')
                
                # åŸºç¡€æ£€æŸ¥
                if not isinstance(image_url, str) or not image_url.startswith('http'):
                    continue
                
                # --- ä¸¥æ ¼éµå®ˆä½ çš„ douban.py å‘½åé€»è¾‘ ---
                # ç›´æ¥å– URL æœ€åä¸€æ®µ (å¦‚ 35774681.jpg)
                image_name = image_url.split("/")[-1]
                save_path = os.path.join(save_dir, image_name)
                
                # å¢é‡æ£€æŸ¥ï¼šæœ‰äº†å°±ä¸ä¸‹
                if os.path.exists(save_path):
                    continue
                
                # --- å…³é”®ä¿®æ”¹ï¼šç»•è¿‡ GitHub IP å°é” ---
                # åŸç†ï¼šGitHub ç›´æ¥è®¿é—® lithub.cc ä¼šè¢«æ‹’ï¼Œæ‰€ä»¥æˆ‘ä»¬åŠ ä¸ªå…è´¹çš„å…¬å…±ä¸­è½¬
                # è¿™ä¸éœ€è¦ä½ é…ç½®ä»»ä½•æœåŠ¡ï¼Œåªæ˜¯ç»™ URL ç©¿ä¸ªé©¬ç”²
                clean_url = image_url.replace('https://', '').replace('http://', '')
                proxy_url = f"https://wsrv.nl/?url={clean_url}"

                try:
                    print(f"ğŸ“¥ ä¸‹è½½ä¸­: {image_name}")
                    # ä½¿ç”¨ä»£ç† URL ä¸‹è½½ï¼Œä¿å­˜ä¸ºåŸæ–‡ä»¶å
                    response = requests.get(proxy_url, timeout=60)
                    
                    # æ£€æŸ¥æ˜¯ä¸æ˜¯çœŸå›¾ç‰‡ (æ’é™¤ 404 ç½‘é¡µ)
                    if response.status_code == 200 and response.content[:4] != b'<htm':
                        with open(save_path, 'wb') as f:
                            f.write(response.content)
                        time.sleep(0.2) # ç¨å¾®å¿«ç‚¹æ²¡å…³ç³»
                    else:
                        print(f"âš ï¸ ä¸‹è½½å¤±è´¥: {image_url}")
                        
                except Exception as e:
                    print(f"âŒ å¼‚å¸¸: {e}")

        if __name__ == '__main__':
            download()
        EOF

    # 5. æ¨é€å›¾ç‰‡ (ä½ çš„æ ¸å¿ƒè¦æ±‚ï¼šæŠŠå›¾å­˜åˆ°ç§æœ‰åº“)
    - name: Push to Img Repo
      run: |
        cd img_repo
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        mkdir -p douban
        git add douban/
        if [[ -n $(git status -s) ]]; then
          git commit -m "chore: save posters to local"
          git push
        else
          echo "æ²¡æœ‰æ–°å›¾ç‰‡éœ€è¦æ¨é€"
        fi

    # 6. æäº¤ CSV (ä¿æŒåšå®¢æ•°æ®åŒæ­¥)
    - name: Commit Blog CSV
      id: commit_step
      uses: EndBug/add-and-commit@v9
      with:
        message: 'chore: update douban data'
        add: './assets'
        
    # 7. è§¦å‘åšå®¢æ„å»º
    - name: Trigger Blog
      if: steps.commit_step.outputs.committed == 'true'
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'githubblog.yml',
            ref: 'main'
          })