name: douban
on: 
  workflow_dispatch:

jobs:
  douban:
    name: Douban mark data sync
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Blog Repo
      uses: actions/checkout@v3

    # 1. å‡†å¤‡å›¾ç‰‡ä»“åº“
    - name: Checkout Private Img Repo
      uses: actions/checkout@v3
      with:
        repository: koobai/img
        token: ${{ secrets.MY_IMG_TOKEN }}
        path: img_repo

    # 2. åŒæ­¥è±†ç“£æ•°æ®
    - name: Douban movie sync
      uses: lizheming/doumark-action@master
      with:
        id: jnnsu
        type: movie
        format: csv
        dir: ./assets

    # 3. å‡†å¤‡ç¯å¢ƒ (ä¾ç„¶éœ€è¦ pandas è¯»å– csv)
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: pip install pandas

    # 4. ä¸‹è½½æ ¸å¿ƒï¼šä½¿ç”¨ Shell + Curl (æ¨¡æ‹Ÿæµè§ˆå™¨è¡Œä¸º)
    - name: Download Posters with Curl
      run: |
        python - <<EOF
        import pandas as pd
        import os
        import subprocess
        from urllib.parse import quote

        csv_path = './assets/movie.csv'
        save_folder = './img_repo/douban/'
        os.makedirs(save_folder, exist_ok=True)

        if not os.path.exists(csv_path):
            print("âŒ CSVæ–‡ä»¶æœªæ‰¾åˆ°")
            exit(1)

        try:
            df = pd.read_csv(csv_path)
        except Exception as e:
            print(f"âŒ è¯»å–CSVå‡ºé”™: {e}")
            exit(1)

        print(f"ğŸ“Š å¼€å§‹å¤„ç† {len(df)} æ¡æ•°æ®...")

        # æµè§ˆå™¨ä¼ªè£…å¤´ (Curl ä¼šç”¨åˆ°)
        user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"

        for index, row in df.iterrows():
            image_url = row['poster']
            movie_id = str(row['id'])

            if pd.isna(image_url) or not str(image_url).startswith('http'):
                continue

            file_name = f"{movie_id}.jpg"
            save_path = os.path.join(save_folder, file_name)

            # å¢é‡æ£€æŸ¥
            if os.path.exists(save_path):
                continue

            print(f"ğŸš€ å¤„ç†ä¸­: {movie_id} -> {image_url}")

            # ç­–ç•¥A: ç›´è¿ä¸‹è½½ (æ¨¡æ‹Ÿæµè§ˆå™¨)
            # -L: è·Ÿéšé‡å®šå‘
            # -f: å‘ç”Ÿ HTTP é”™è¯¯æ—¶ä¸å†™å…¥æ–‡ä»¶
            # -s: é™é»˜æ¨¡å¼ (å‡å°‘æ—¥å¿—å™ªéŸ³)
            # --retry 3: å¤±è´¥é‡è¯•3æ¬¡
            curl_cmd_direct = [
                'curl', '-L', '-f', '-s',
                '--retry', '3',
                '--retry-delay', '1',
                '-H', f'User-Agent: {user_agent}',
                '-H', 'Referer: https://movie.douban.com/',
                '-o', save_path,
                image_url
            ]

            # æ‰§è¡Œç›´è¿
            result = subprocess.run(curl_cmd_direct)

            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ (å­˜åœ¨ä¸”å¤§äº 1KB)
            download_success = False
            if os.path.exists(save_path) and os.path.getsize(save_path) > 1024:
                download_success = True
                print("âœ… ç›´è¿ä¸‹è½½æˆåŠŸ")
            else:
                # å¤±è´¥æˆ–æ–‡ä»¶å¤ªå°(å¯èƒ½æ˜¯é”™è¯¯é¡µ)ï¼Œæ¸…ç†æ‰
                if os.path.exists(save_path): os.remove(save_path)
                print("âš ï¸ ç›´è¿å¤±è´¥æˆ–æ–‡ä»¶æ— æ•ˆï¼Œå°è¯•ä»£ç†...")

                # ç­–ç•¥B: ä½¿ç”¨ wsrv.nl ä»£ç† (Curl æ–¹å¼)
                clean_url = image_url.replace('https://', '').replace('http://', '')
                encoded_url = quote(clean_url, safe='')
                proxy_url = f"https://wsrv.nl/?url={encoded_url}&output=jpg"
                
                curl_cmd_proxy = [
                    'curl', '-L', '-f', '-s',
                    '--retry', '3',
                    '-o', save_path,
                    proxy_url
                ]
                subprocess.run(curl_cmd_proxy)

                # å†æ¬¡æ£€æŸ¥
                if os.path.exists(save_path) and os.path.getsize(save_path) > 1024:
                    download_success = True
                    print("âœ… ä»£ç†ä¸‹è½½æˆåŠŸ")
                else:
                    if os.path.exists(save_path): os.remove(save_path)
                    print(f"âŒ å…¨éƒ¨å¤±è´¥: {movie_id}")

        EOF

    # 5. æ¨é€å›¾ç‰‡
    - name: Push to Img Repo
      run: |
        cd img_repo
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        # å¼ºåˆ¶æ·»åŠ  douban ç›®å½•ï¼Œé˜²æ­¢ä¸ºç©º
        mkdir -p douban
        git add douban/
        # æ£€æŸ¥çŠ¶æ€ï¼Œåªæœ‰çœŸæ­£æœ‰å˜åŒ–æ‰æäº¤
        if [[ -n $(git status -s) ]]; then
          git commit -m "chore: sync posters with curl"
          git push
        else
          print("æ— æ–°å›¾ç‰‡éœ€è¦æäº¤")
        fi

    # 6. æäº¤ CSV
    - name: Commit Blog CSV
      id: commit_step
      uses: EndBug/add-and-commit@v9
      with:
        message: 'chore: update douban data'
        add: './assets'

    # 7. è§¦å‘åšå®¢
    - name: Trigger Blog
      if: steps.commit_step.outputs.committed == 'true'
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'githubblog.yml',
            ref: 'main'
          })