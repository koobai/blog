name: douban
on: 
  workflow_dispatch:
  # schedule:
  #   - cron: '0 18 * * *'

jobs:
  douban:
    name: Douban mark data sync
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Blog Repo
      uses: actions/checkout@v3

    # 1. å‡†å¤‡å›¾ç‰‡ä»“åº“
    - name: Checkout Private Img Repo
      uses: actions/checkout@v3
      with:
        repository: koobai/img
        token: ${{ secrets.MY_IMG_TOKEN }}
        path: img_repo

    # 2. åŒæ­¥è±†ç“£æ•°æ®
    - name: Douban movie sync
      uses: lizheming/doumark-action@master
      with:
        id: jnnsu
        type: movie
        format: csv
        dir: ./assets

    # 3. ç¯å¢ƒå‡†å¤‡
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: pip install pandas requests

    # 4. è¿è¡Œç”Ÿäº§çº§ä¸‹è½½è„šæœ¬ (wsrv + lithub æ··åˆåŒæ‰“)
    - name: Download Posters
      run: |
        python - <<EOF
        import pandas as pd
        import requests
        import os
        import time
        import random
        from urllib.parse import quote

        def download():
            csv_path = './assets/movie.csv'
            save_folder = './img_repo/douban/'
            os.makedirs(save_folder, exist_ok=True)
            
            if not os.path.exists(csv_path):
                print("âŒ CSVæ–‡ä»¶æœªæ‰¾åˆ°")
                return

            try:
                df = pd.read_csv(csv_path)
            except Exception as e:
                print(f"âŒ è¯»å–CSVå‡ºé”™: {e}")
                return
            
            print(f"ğŸ“Š å¼€å§‹å¤„ç† {len(df)} æ¡æ•°æ®...")
            
            for index, row in df.iterrows():
                image_url = row['poster']
                
                # åŸºç¡€è¿‡æ»¤ï¼šç©ºå€¼æˆ–é URL è·³è¿‡
                if pd.isna(image_url) or not str(image_url).startswith('http'):
                    continue
                
                # ä½¿ç”¨ movie_id ä½œä¸ºæ–‡ä»¶åï¼Œç¡®ä¿å’Œæ•°æ®ä¸€ä¸€å¯¹åº”
                # è¿™æ ·å³ä½¿ lithub é“¾æ¥å˜äº†ï¼Œåªè¦ id æ²¡å˜ï¼Œå›¾ç‰‡å°±ä¸ä¼šé‡å¤ä¸‹
                movie_id = str(row['id'])
                file_name = f"{movie_id}.jpg"
                save_path = os.path.join(save_folder, file_name)
                
                # âœ… å¢é‡æ£€æµ‹ï¼šæ–‡ä»¶å­˜åœ¨åˆ™è·³è¿‡
                if os.path.exists(save_path):
                    continue
                
                # âœ… æ ¸å¿ƒé€»è¾‘ï¼šæ„é€  wsrv ä»£ç†é“¾æ¥
                # 1. æ¸…ç† http/https å‰ç¼€
                clean_url = image_url.replace('https://', '').replace('http://', '')
                # 2. URL ç¼–ç ï¼Œé˜²æ­¢ç‰¹æ®Šå­—ç¬¦å¯¼è‡´ wsrv è§£æå¤±è´¥
                encoded_url = quote(clean_url, safe='')
                # 3. æ‹¼æ¥ä»£ç†åœ°å€
                proxy_url = f"https://wsrv.nl/?url={encoded_url}"
                
                try:
                    print(f"ğŸ“¥ ä»£ç†ä¸‹è½½ä¸­: {movie_id} -> {file_name}")
                    # è¶…æ—¶è®¾ç½®é•¿ä¸€ç‚¹ï¼Œç»™ä»£ç†æœåŠ¡å™¨ç¼“å†²æ—¶é—´
                    res = requests.get(proxy_url, timeout=60)
                    
                    # âœ… é˜²è„æ•°æ®ï¼šæ£€æŸ¥æ˜¯å¦è¿”å›äº† HTML (wsrv æŠ¥é”™é¡µé¢)
                    if res.status_code == 200 and res.content[:4] != b'<htm':
                        with open(save_path, 'wb') as f:
                            f.write(res.content)
                        # ç¤¼è²Œå»¶æ—¶ï¼Œå¯¹å…¬å…±æœåŠ¡å‹å¥½
                        time.sleep(0.5)
                    else:
                        print(f"âš ï¸ ä¸‹è½½å¤±è´¥æˆ–éå›¾ç‰‡å†…å®¹: {image_url}")
                        
                except Exception as e:
                    print(f"âŒ è¯·æ±‚å¼‚å¸¸: {e}")

        if __name__ == "__main__":
            download()
        EOF

    # 5. æ¨é€å›¾ç‰‡
    - name: Push to Img Repo
      run: |
        cd img_repo
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        mkdir -p douban
        git add douban/
        # åªæœ‰æœ‰å˜åŠ¨æ‰æäº¤ï¼Œé˜²æ­¢æŠ¥é”™
        git commit -m "chore: sync posters via wsrv" || exit 0
        git push

    # 6. æäº¤ CSV (å¯é€‰ï¼Œå¦‚æœåªæ˜¯ä¸ºäº†è§¦å‘æ„å»º)
    - name: Commit Blog CSV
      id: commit_step
      uses: EndBug/add-and-commit@v9
      with:
        message: 'chore: update douban data'
        add: './assets'
        
    # 7. è§¦å‘åšå®¢æ„å»º
    - name: Trigger Blog
      if: steps.commit_step.outputs.committed == 'true'
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'githubblog.yml',
            ref: 'main'
          })