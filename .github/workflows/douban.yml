name: douban
on: 
  workflow_dispatch:

jobs:
  douban:
    name: Douban mark data sync
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Blog Repo
      uses: actions/checkout@v3

    # 1. å‡†å¤‡å›¾ç‰‡ä»“åº“
    - name: Checkout Private Img Repo
      uses: actions/checkout@v3
      with:
        repository: koobai/img
        token: ${{ secrets.MY_IMG_TOKEN }}
        path: img_repo

    # 2. åŒæ­¥è±†ç“£æ•°æ®
    - name: Douban movie sync
      uses: lizheming/doumark-action@master
      with:
        id: jnnsu
        type: movie
        format: csv
        dir: ./assets

    # 3. ç¯å¢ƒå‡†å¤‡
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: pip install pandas requests

    # 4. ä¸‹è½½è„šæœ¬ï¼šç›´æ¥è¯·æ±‚ CSV é‡Œçš„ poster é“¾æ¥
    - name: Download Posters
      run: |
        python - <<EOF
        import pandas as pd
        import requests
        import os
        import time

        def download():
            csv_path = './assets/movie.csv'
            save_folder = './img_repo/douban/'
            os.makedirs(save_folder, exist_ok=True)
            
            if not os.path.exists(csv_path):
                print("âŒ CSVæ–‡ä»¶æœªæ‰¾åˆ°")
                return

            try:
                df = pd.read_csv(csv_path)
            except Exception as e:
                print(f"âŒ è¯»å–CSVå‡ºé”™: {e}")
                return
            
            print(f"ğŸ“Š å¼€å§‹å¤„ç† {len(df)} æ¡æ•°æ®...")
            
            # å…³é”®ï¼šä¼ªè£…æˆ Chrome æµè§ˆå™¨ï¼Œè§£å†³è„šæœ¬è¯·æ±‚è¢«æ‹’çš„é—®é¢˜
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                # æ—¢ç„¶æ˜¯ lithub é•œåƒï¼Œä¸€èˆ¬ä¸éœ€è¦ç‰¹å®š Refererï¼Œæˆ–è€…ç•™ç©ºå³å¯
            }

            for index, row in df.iterrows():
                image_url = row['poster']
                movie_id = str(row['id'])
                
                # è·³è¿‡ç©ºæ•°æ®
                if pd.isna(image_url) or not str(image_url).startswith('http'):
                    continue

                # æ–‡ä»¶åä½¿ç”¨ ID.jpgï¼Œæ–¹ä¾¿ç®¡ç†
                file_name = f"{movie_id}.jpg"
                save_path = os.path.join(save_folder, file_name)
                
                # å¢é‡æ£€æŸ¥ï¼šæœ‰äº†å°±ä¸ä¸‹
                if os.path.exists(save_path):
                    continue
                
                try:
                    print(f"ğŸ“¥ æ­£åœ¨ä¸‹è½½: {image_url}")
                    # ç›´æ¥è¯·æ±‚ lithub åœ°å€
                    res = requests.get(image_url, headers=headers, timeout=30)
                    
                    if res.status_code == 200:
                        with open(save_path, 'wb') as f:
                            f.write(res.content)
                        # æˆåŠŸ
                        time.sleep(0.5)
                    else:
                        print(f"âš ï¸ ä¸‹è½½å¤±è´¥ (çŠ¶æ€ç  {res.status_code}): {image_url}")
                        
                except Exception as e:
                    print(f"âŒ è¯·æ±‚å¼‚å¸¸: {e}")

        if __name__ == "__main__":
            download()
        EOF

    # 5. æ¨é€å›¾ç‰‡
    - name: Push to Img Repo
      run: |
        cd img_repo
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        mkdir -p douban
        git add douban/
        git commit -m "chore: sync posters directly" || exit 0
        git push

    # 6. è§¦å‘æ„å»º
    - name: Trigger Blog
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'githubblog.yml',
            ref: 'main'
          })