name: douban
on: 
  workflow_dispatch:
  # schedule:
  #   - cron: '0 18 * * *'

jobs:
  douban:
    name: Douban mark data sync
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    # 1. å…ˆæŠ“å–è±†ç“£æ•°æ®ç”Ÿæˆ CSV (è¿™ä¸€æ­¥æ˜¯æ ¸å¿ƒæ•°æ®ï¼Œå¿…é¡»ä¿è¯å…ˆæˆåŠŸ)
    - name: movie
      uses: lizheming/doumark-action@master
      with:
        id: jnnsu
        type: movie
        format: csv
        dir: ./assets

    # 2. ç«‹å³æäº¤ CSV (é˜²æ­¢åé¢ä¸‹è½½å›¾ç‰‡å‡ºé”™å¯¼è‡´æ•°æ®æ²¡ä¿å­˜)
    - name: Commit CSV
      id: commit_step
      uses: EndBug/add-and-commit@v9
      with:
        message: 'chore: update douban data'
        add: './assets'

    # --- å¼€å§‹ä¸‹è½½å›¾ç‰‡æµç¨‹ ---
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Dependencies
      run: pip install pandas requests

    # 3. ä¸‹è½½æµ·æŠ¥ (é€šè¿‡ Weserv ä»£ç†ç»•è¿‡ 104 å°é”)
    - name: Download Posters via Proxy
      run: |
        python - <<EOF
        import pandas as pd
        import requests
        import os
        import time

        # è¯»å–åˆšç”Ÿæˆçš„ CSV
        try:
            df = pd.read_csv("./assets/movie.csv")
        except:
            print("No CSV found, skipping download.")
            exit(0)

        temp_dir = "temp_posters"
        os.makedirs(temp_dir, exist_ok=True)

        print("ğŸš€ Starting download via images.weserv.nl proxy...")

        for _, row in df.iterrows():
            orig_url = row["poster"]
            if not isinstance(orig_url, str) or not orig_url.startswith('http'):
                continue
            
            # æå–æ–‡ä»¶å (ID.jpg)
            img_name = os.path.basename(orig_url)
            path = os.path.join(temp_dir, img_name)
            
            # æœ¬åœ°å·²å­˜åœ¨åˆ™è·³è¿‡
            if os.path.exists(path):
                continue

            # --- æ ¸å¿ƒä¿®æ”¹ï¼šæ„é€ ä»£ç† URL ---
            # åŸç†ï¼šè®© weserv.nl å¸®æˆ‘ä»¬å»å–å›¾ç‰‡ï¼Œç»•è¿‡ IP å°é”
            # ç§»é™¤ https:// å‰ç¼€ï¼Œå› ä¸º weserv æ ¼å¼é€šå¸¸æ˜¯ url=ssl:domain.com/path
            clean_url = orig_url.replace("https://", "")
            proxy_url = f"https://images.weserv.nl/?url={clean_url}&output=jpg"

            try:
                # ä¼ªè£… Header ä¾ç„¶å¸¦ç€ï¼Œä»¥é˜²ä¸‡ä¸€
                headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}
                
                # è¯·æ±‚ä»£ç†æœåŠ¡å™¨
                r = requests.get(proxy_url, headers=headers, timeout=20)
                
                if r.status_code == 200:
                    # æ£€æŸ¥è¿”å›çš„æ˜¯å¦æ˜¯é”™è¯¯ JSON (weserv å‡ºé”™ä¼šè¿”å› json)
                    if r.headers.get('Content-Type', '').startswith('application/json'):
                        print(f"âŒ Proxy Error for {img_name}")
                        continue

                    with open(path, "wb") as f:
                        f.write(r.content)
                    print(f"âœ… Success: {img_name}")
                else:
                    print(f"âŒ Failed ({r.status_code}): {img_name}")
            
            except Exception as e:
                print(f"âŒ Error downloading {img_name}: {e}")
            
            # ç¨å¾®ä¼‘æ¯ä¸€ä¸‹ï¼Œåˆ«æŠŠä»£ç†æœåŠ¡ä¹Ÿåˆ·çˆ†äº†
            time.sleep(0.2)
        EOF

    # 4. åŒæ­¥åˆ° img ä»“åº“
    - name: Checkout img repo
      uses: actions/checkout@v3
      with:
        repository: koobai/img
        token: ${{ secrets.IMG_REPO_TOKEN }}
        path: img-repo

    - name: Sync and Push Images
      run: |
        mkdir -p img-repo/douban
        # -n ä¸è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶
        cp -n temp_posters/* img-repo/douban/ || true
        
        cd img-repo
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        if [ -n "$(git status --porcelain)" ]; then
          git add .
          git commit -m "chore: sync posters via weserv"
          git push
        else
          echo "No new images to sync."
        fi

    # 5. è§¦å‘åšå®¢æ„å»º
    - name: Trigger Blog
      if: steps.commit_step.outputs.committed == 'true'
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'githubblog.yml',
            ref: 'main'
          })